{% extends "base.html" %}

{% block content %}
<nav class="flex items-center border-b border-gray-200 px-6 py-4 bg-white shadow-sm">
    <div class="w-full max-w-4xl mx-auto flex items-center justify-between flex-wrap gap-4">
        <div class="flex-grow truncate">
            {% if note.user_id == current_user.id %}
                <h1 id="title" class="text-2xl font-bold text-gray-900 truncate cursor-pointer" onclick="edit_title()">
                    {{ note.title }}
                </h1>
                <form id="title-form" method="post" class="flex items-center gap-3">
                    {{ form.hidden_tag() }}
                    {{ form.title(id="flask-form-title", 
                                  class="input-field", 
                                  style="display: none;", 
                                  value=note.title, 
                                  onblur="this.form.submit()") }}
                    <button id="js-save-title-btn" type="submit"
                            class="submit-btn"
                            style="display: none;">
                        Save
                    </button>
                </form>
            {% else %}
                <h1 class="text-2xl font-bold text-gray-900 truncate">{{ note.title }}</h1>
            {% endif %}
        </div>
    </div>
</nav>

<section class="max-w-2xl mx-auto bg-white rounded-xl shadow p-8 my-14">
    <div id="note-editor" class="prose max-w-none text-lg text-gray-800 leading-relaxed min-h-[300px]">{{ note.text | safe }}</div>

    {% if note.user_id == current_user.id %}
        <div class="flex justify-end mt-8 gap-4">
            <button id="js-edit-note-btn" class="btn-primary submit-btn" onclick="edit_note()">Edit Note</button>
            <form id="note-form" method="post" class="hidden">
                {{ form.hidden_tag() }}
                {{ form.note(id="flask-form-note", class="hidden") }}
                <button id="js-save-note-btn" type="submit" class="submit-btn">Save Note</button>
            </form>
        </div>
        <aside x-data="{ showVersionSection: false }" class="fixed top-20 right-10 bg-white p-4 rounded-lg shadow-lg w-60 text-center z-50">
            <button type="button" @click="showVersionSection = !showVersionSection" class="btn-primary w-full mb-3 submit-btn">
                History
            </button>
            <div
                x-show="showVersionSection"
                x-transition:enter="transition transform ease-out duration-300"
                x-transition:enter-start="opacity-0 scale-y-0"
                x-transition:enter-end="opacity-100 scale-y-100"
                x-transition:leave="transition transform ease-in duration-200"
                x-transition:leave-start="opacity-100 scale-y-100"
                x-transition:leave-end="opacity-0 scale-y-0"
                class="fixed overflow-y-auto max-h-64 transform origin-top bg-white rounded shadow-lg p-4 w-60 text-center z-50 right-10"
                style="display: none;"
            >
                <ul class="divide-y divide-gray-200">
                    {% for version in note_versions %}
                    <li class="py-2 hover:bg-gray-100 rounded">
                        <a href="{{ url_for('notes.note', note_id=note.id, version_id=version.id) }}" class="block text-blue-600 hover:underline">
                            {{ version.version_date.strftime("%Y-%m-%d %H:%M") }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>
    {% endif %}
</section>

<!-- Quill editor JS -->
<script src="{{ url_for('static', filename='quill/quill.js') }}"></script>
<script src="{{ url_for('static', filename='js/index.js') }}"></script>

<script>
    const text_editor = new TextEditor("#note-editor")            
    text_editor.toolbar(false)
    text_editor.update()

    function edit_note() {
        text_editor.setTheme("snow")
        text_editor.update(false)

        document.getElementById('js-edit-note-btn').style.display = 'none';
        document.getElementById('note-form').classList.remove('hidden');
    }

    function edit_title() {
        const editTitleInput = document.getElementById("flask-form-title");
        const titleBtn = document.getElementById("title");
        const saveTitleBtn = document.getElementById('js-save-title-btn');

        editTitleInput.style.display = "block";
        editTitleInput.focus();

        titleBtn.style.display = "none";
        saveTitleBtn.style.display = "inline-block";
    }

    const noteForm = document.getElementById('note-form');
    if (noteForm) {
        noteForm.addEventListener('submit', function (e) {
            const hiddenField = document.getElementById('flask-form-note');
            hiddenField.value = text_editor.root.innerHTML;
        });
    }
</script>
{% endblock %}
